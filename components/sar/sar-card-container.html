<link href="../polymer/polymer.html" rel="import">

<link href="../firebase-element/firebase-collection.html" rel="import">
<link href="../neon-animation/neon-shared-element-animatable-behavior.html" rel="import">

<link href="../sar/sar-card.html" rel="import">


<dom-module id="sar-card-container">
  <style is="custom-style">
    :host {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      align-items: stretch;
    }
  </style>
  <template>
      <firebase-collection
          order-by-child="title"
          log="true"
          location="https://sexy-anime-reviews.firebaseio.com/reviews"
          data="{{reviews}}"></firebase-collection>
      <template is="dom-repeat" items="[[reviews]]">
        <sar-card review="[[item]]" on-card-click="_onCardClick"></sar-card>
      </template>
  </template>
</dom-module>

<script>
</script>
<script>
  Polymer({
    is: 'sar-card-container',
    behaviors: [
      Polymer.NeonSharedElementAnimatableBehavior
    ],
    properties: {
      reviews: Object,
      animationConfig: {
        value: function() {
          // var cards = Polymer.dom(this.root).querySelectorAll('.card');
          // var cardsArray = Array.prototype.slice.call(cards);
          return {
            'entry': [{
              name: 'hero-animation',
              id: 'hero',
              toPage: this
            }, {
              name: 'cascaded-animation',
              // nodes: cardsArray,
              animation: 'transform-animation'
            }, {
              name: 'fade-in-animation',
              timing: {
                delay: 500,
                duration: 100
              }
            }],
            'exit': [{
              name: 'hero-animation',
              id: 'hero',
              fromPage: this,
              timing: {
                delay: 100
              }
            }, {
              name: 'cascaded-animation',
              animation: 'transform-animation',
              nodedelay: 50
            }, {
              name: 'fade-out-animation',
              timing: {
                duration: 100
              }
            }]
          };
        }
      }
    },
    _onCardClick: function(event) {
      var target = Polymer.dom(event).localTarget;
      this.sharedElements = {
        'hero': event.detail.cover
      };
      var nodesToExit = [];
      var cards = Polymer.dom(this.root).querySelectorAll('sar-card');
      var farthestDistance = 0;  // card top relative to viewport bottom edge
      var viewportHeight = window.document.body.clientHeight;
      for (var node, idx = 0; node = cards[idx]; idx++) {
        if (node !== target && this._isNodeInViewport(node)) {
          nodesToExit.push(node);
          // distance of node's top to viewport bottom edge
          var d = viewportHeight - this.getBoundingClientRect().top;
          farthestDistance = d > farthestDistance ? d : farthestDistance;
        }
      }
      this.animationConfig['entry'][1].transformFrom = 'translateY(' + farthestDistance + 'px)';
      this.animationConfig['exit'][1].transformTo = 'translateY(' + farthestDistance + 'px)';
      this.animationConfig['entry'][1].nodes = nodesToExit;
      this.animationConfig['exit'][1].nodes = nodesToExit;
      this.animationConfig['entry'][2].node = event.detail.title;
      this.animationConfig['exit'][2].node = event.detail.title;

      this.fire('card-selected', {review: event.detail.review});
    },
    _isNodeInViewport: function(node) {
      return node.getBoundingClientRect().bottom > 0 &&
          node.getBoundingClientRect().top < window.document.body.clientHeight;
    }
  });
</script>