<link href="../polymer/polymer.html" rel="import">

<link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="../firebase-element/firebase-collection.html" rel="import">
<link href="../neon-animation/neon-shared-element-animatable-behavior.html" rel="import">
<link href="../paper-scroll-header-panel/paper-scroll-header-panel.html" rel="import">

<link href="../sar/sar-card.html" rel="import">


<dom-module id="sar-card-container">
  <style is="custom-style">
    :host {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      align-items: stretch;
      height: 100%;
      @apply(--layout);
      @apply(--layout-fit);
    }
    #header {
      color: silver;
      font-size: 54px;
      font-family: 'PT Sans Narrow', 'Open Sans', Helvetica, Arial, sans-serif;
      @apply(--layout-self-end);
    }
    paper-scroll-header-panel {
      @apply(--layout-fit);
    }
    .paper-header {
      padding: 0 10%;
      white-space: nowrap;
      height: 168px;
      @apply(--layout);
    }
    .content {
      padding: 0 10%;
      margin-top: 48px;
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
    }
  </style>
  <template>
    <firebase-collection
        order-by-child="title"
        log="true"
        location="https://sexy-anime-reviews.firebaseio.com/reviews"
        data="{{reviews}}"></firebase-collection>
    <paper-scroll-header-panel>
      <div class="paper-header">
        <div id="header">Sexy Anime Reviews</div>
      </div>
      <div class="content">
        <template is="dom-repeat" items="[[reviews]]">
          <sar-card review="[[item]]" on-card-click="_onCardClick"></sar-card>
        </template>
      </div>
    </paper-scroll-header-panel>
  </template>
</dom-module>

<script>
</script>
<script>
  Polymer({
    is: 'sar-card-container',
    behaviors: [
      Polymer.NeonSharedElementAnimatableBehavior
    ],
    properties: {
      reviews: Object,
      animationConfig: {
        value: function() {
          // var cards = Polymer.dom(this.root).querySelectorAll('.card');
          // var cardsArray = Array.prototype.slice.call(cards);
          return {
            'entry': [{
              name: 'hero-animation',
              id: 'hero',
              toPage: this
            }, {
              name: 'cascaded-animation',
              // nodes: cardsArray,
              animation: 'transform-animation'
            }, {
              name: 'fade-in-animation',
              timing: {
                delay: 500,
                duration: 100
              }
            }, {
              name: 'hero-animation',
              id: 'hero-header',
              toPage: this
            }],
            'exit': [{
              name: 'hero-animation',
              id: 'hero',
              fromPage: this,
              timing: {
                delay: 100
              }
            }, {
              name: 'cascaded-animation',
              animation: 'transform-animation',
              nodedelay: 50
            }, {
              name: 'fade-out-animation',
              timing: {
                duration: 100
              }
            }, {
              name: 'hero-animation',
              id: 'hero-header',
              fromPage: this
            }]
          };
        }
      }
    },
    _onCardClick: function(event) {
      var target = Polymer.dom(event).localTarget;
      this.sharedElements = {
        'hero': event.detail.cover,
        'hero-header': this.$.header
      };
      var nodesToExit = [];
      var cards = Polymer.dom(this.root).querySelectorAll('sar-card');
      var farthestDistance = 0;  // card top relative to viewport bottom edge
      var viewportHeight = window.document.documentElement.clientHeight;
      for (var node, idx = 0; node = cards[idx]; idx++) {
        if (node !== target && this._isNodeInViewport(node)) {
          nodesToExit.push(node);
          // distance of node's top to viewport bottom edge
          var d = viewportHeight - this.getBoundingClientRect().top;
          farthestDistance = d > farthestDistance ? d : farthestDistance;
        }
      }
      this.animationConfig['entry'][1].transformFrom = 'translateY(' + farthestDistance + 'px)';
      this.animationConfig['exit'][1].transformTo = 'translateY(' + farthestDistance + 'px)';
      this.animationConfig['entry'][1].nodes = nodesToExit;
      this.animationConfig['exit'][1].nodes = nodesToExit;
      this.animationConfig['entry'][2].node = event.detail.title;
      this.animationConfig['exit'][2].node = event.detail.title;

      this.fire('card-selected', {review: event.detail.review});
    },
    _isNodeInViewport: function(node) {
      return node.getBoundingClientRect().bottom > 0 &&
          node.getBoundingClientRect().top < window.document.documentElement.clientHeight;
    }
  });
</script>